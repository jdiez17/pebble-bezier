#include "bezier.h"

GPoint* numbers_font[] = {
    (GPoint[]) { // 0
      {42.333333,7.833333}, {26.500000,14.000000}, {20.500000,26.333333}, {21.833333,43.000000}, 
      {21.833333,43.000000}, {23.166667,59.666667}, {27.833333,74.166667}, {42.666667,74.333333}, 
      {42.666667,74.333333}, {57.500000,74.500000}, {61.500000,58.166667}, {61.500000,45.833333}, 
      {61.500000,45.833333}, {61.500000,33.500000}, {60.833333,13.500000}, {38.500000,12.500000}, 
    },
    
    (GPoint[]) { // 1 
      {23.000000,30.000000}, {37.666667,16.500000}, {38.333333,9.666667}, {40.500000,7.166667}, 
      {40.500000,7.166667}, {42.666667,4.666667}, {42.000000,16.666667}, {42.166667,27.833333}, 
      {42.166667,27.833333}, {42.333333,39.000000}, {42.333333,32.333333}, {42.500000,50.500000}, 
      {42.500000,50.500000}, {42.666667,68.666667}, {42.333333,60.166667}, {42.500000,70.666667}, 
    },

    (GPoint[]) { // 2 
      {17.333333,18.500000}, {25.333333,9.166667}, {34.666667,4.333333}, {45.166667,8.333333}, 
      {45.166667,8.333333}, {55.666667,12.333333}, {60.000000,26.500000}, {56.000000,40.166667}, 
      {56.000000,40.166667}, {52.000000,53.833333}, {22.666667,75.666667}, {20.000000,67.500000}, 
      {20.000000,67.500000}, {17.333333,59.333333}, {54.500000,65.500000}, {62.166667,69.000000}, 
    },

    (GPoint []) { // 3
      {16.000000,22.000000}, {18.833333,2.333333}, {44.500000,2.833333}, {51.833333,17.833333}, 
      {51.833333,17.833333}, {59.166667,32.833333}, {31.666667,47.500000}, {30.333333,41.666667}, 
      {30.333333,41.666667}, {29.000000,35.833333}, {66.000000,45.500000}, {56.333333,64.666667}, 
      {56.333333,64.666667}, {46.666667,83.833333}, {18.333333,74.166667}, {15.500000,65.166667}, 
    },

    (GPoint []) { // 4
      {62.333333,40.666667}, {41.500000,38.333333}, {32.000000,39.000000}, {21.833333,39.833333}, 
      {21.833333,39.833333}, {11.666667,40.666667}, {23.666667,23.000000}, {32.000000,14.000000}, 
      {32.000000,14.000000}, {40.333333,5.000000}, {47.166667,-5.000000}, {43.333333,18.000000}, 
      {43.333333,18.000000}, {39.500000,41.000000}, {41.000000,72.500000}, {41.166667,73.000000}, 
    },

    (GPoint []) { // 5
      {56.666667,8.666667}, {37.666667,7.000000}, {25.500000,7.333333}, {24.000000,10.166667}, 
      {24.000000,10.166667}, {22.500000,13.000000}, {24.166667,33.833333}, {25.333333,37.166667}, 
      {25.333333,37.166667}, {26.500000,40.500000}, {58.500000,27.500000}, {60.166667,50.333333}, 
      {60.166667,50.333333}, {61.833333,73.166667}, {43.666667,75.333333}, {24.500000,68.166667}, 
    },

    (GPoint []) { // 6
      {50.166667,4.333333}, {31.833333,17.333333}, {26.666667,37.333333}, {24.833333,49.333333}, 
      {24.833333,49.333333}, {23.000000,61.333333}, {27.166667,75.166667}, {40.333333,76.333333}, 
      {40.333333,76.333333}, {53.500000,77.500000}, {61.166667,67.000000}, {58.000000,53.500000}, 
      {58.000000,53.500000}, {54.833333,40.000000}, {36.666667,40.500000}, {28.000000,47.500000}, 
    },

    (GPoint []) { // 7
      {18.000000,8.666667}, {28.000000,5.666667}, {40.833333,7.000000}, {52.000000,6.333333}, 
      {52.000000,6.333333}, {63.166667,5.666667}, {50.833333,24.166667}, {49.000000,27.666667}, 
      {49.000000,27.666667}, {47.166667,31.166667}, {40.500000,44.500000}, {38.500000,49.166667}, 
      {38.500000,49.166667}, {36.500000,53.833333}, {33.333333,64.666667}, {33.000000,75.333333}, 
    },

    (GPoint []) { // 8
      {40.500000,40.333333}, {56.000000,30.666667}, {58.833333,8.666667}, {40.000000,7.166667}, 
      {40.000000,7.166667}, {21.166667,5.666667}, {23.833333,35.833333}, {37.500000,41.166667}, 
      {37.500000,41.166667}, {51.166667,46.500000}, {67.166667,71.166667}, {41.333333,72.000000}, 
      {41.333333,72.000000}, {15.500000,72.833333}, {20.666667,50.666667}, {36.166667,42.500000}, 
    },

    (GPoint []) { // 9
      {53.666667,17.500000}, {53.833333,1.000000}, {28.500000,5.500000}, {25.166667,14.166667}, 
      {25.166667,14.166667}, {21.833333,22.833333}, {26.833333,30.666667}, {36.500000,31.666667}, 
      {36.500000,31.666667}, {46.166667,32.666667}, {57.666667,24.833333}, {53.666667,20.333333}, 
      {53.666667,20.333333}, {49.666667,15.833333}, {49.500000,60.833333}, {49.500000,74.666667}, 
    },
};

int fact(int n) {
    int result = 1;
    if(n == 0) return result;

    for(int i = 1; i <= n; i++) {
        result *= i;
    }

    return result;
}

float fpow(float n, int exp) {
    float result = 1;
    if(exp == 0) return result; 

    for(int i = 0; i < exp; i++)
        result *= n;

    return result;
}

int lerp(int v0, int v1, float t) {
    return (1 - t) * v0 + t * v1;
}

int binomialCoefficient(int n, int k) {
    int result =  fact(n) / (fact(k) * fact(n - k));

    return result;
}

GPoint lerpBezier(GPoint* points_a, GPoint* points_b, float t, float t_lerp, int path, int n, int xoff, int yoff) {
    int start = path * n;
    int end = (path + 1) * n;

    GPoint result = (GPoint) {0, 0};

    result.x += xoff;
    result.y += yoff;

    for(int i = start; i < end; i++) {
        int local_i = i % n;
        float coef = binomialCoefficient(n - 1, local_i) * fpow((1 - t), n - local_i - 1) * fpow(t, local_i);

        result.x += coef * lerp(points_a[i].x, points_b[i].x, t_lerp); 
        result.y += coef * lerp(points_a[i].y, points_b[i].y, t_lerp);

    }

    return result;
} 

void renderBezierDigit(GContext* ctx, int digit, float t_lerp, int xoff, int yoff, bool should_lerp) {
  int num_curves = 4;
  int lines = 4;
  int order = 4;

  if(!should_lerp)
      t_lerp = 0;
  else {
      if(digit > 0)
          digit--;
      else
          digit = 9;
  }

  GPoint* points_a = numbers_font[digit];
  GPoint* points_b = numbers_font[(digit + 1) % 10];

  GPoint prev = lerpBezier(points_a, points_b, 0, t_lerp, 0, 4, xoff, yoff);
  GPoint current;

  for(int curve = 0; curve < num_curves; curve++) {
      for(float i = 0; i < lines; i++) {
          current = lerpBezier(points_a, points_b, (float) 1/lines * i, t_lerp, curve, order, xoff, yoff);

          graphics_draw_line(ctx, prev, current);
          prev = current;
      }

      // Ensure we actually draw t=1
      current = lerpBezier(points_a, points_b, 1, t_lerp, curve, order, xoff, yoff);
      graphics_draw_line(ctx, prev, current);
  }
}
